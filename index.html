<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>рд╣рд┐рдВрджреА рдСрдбрд┐рдпреЛ рдХреНрд╡рд┐рдЬрд╝ тАФ рд▓рд┐рдВрдЧ & рд╡рдЪрди</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
<style>
body{font-family:'Noto Sans Devanagari',sans-serif;background:#fff9f0;margin:0;padding:20px;color:#111}
h1{color:#b71c1c;text-align:center;margin:6px 0 18px;font-size:2rem}
.center{max-width:760px;margin:0 auto;padding:12px}
.controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:12px}
button{border:none;padding:10px 14px;border-radius:8px;font-size:1rem;cursor:pointer;transition:background 0.2s}
button.blue{background:#1565c0;color:#fff;box-shadow:0 2px 0 rgba(0,0,0,0.08)}
button.blue:active{background:#0d47a1}
button.gray{background:#6c757d;color:#fff}
button.gray:active{background:#5a6268}
button:disabled{opacity:0.5;cursor:not-allowed}
input[type=text]{width:100%;padding:12px;border-radius:8px;border:1px solid #ccc;font-size:1rem;box-sizing:border-box}
#question{text-align:left;font-size:1.6rem;margin:18px 0 8px}
#translation{color:#666;margin-bottom:8px}
#feedback{min-height:28px;margin-top:12px;font-weight:700}
#feedback.correct{color:#0b5;display:inline-block}
#feedback.wrong{color:#c00;display:inline-block}
.note{color:#b71c1c;margin-top:18px;font-weight:700}
.small{font-size:0.9rem;color:#666;margin-top:12px;text-align:center}
#loginModal{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:999}
.loginBox{background:#fff;padding:20px;border-radius:10px;max-width:360px;width:90%;text-align:center;box-shadow:0 6px 20px rgba(0,0,0,0.2)}
.loginBox input{margin:8px 0}
#logoutBtn{background:#b71c1c;color:#fff;margin-top:10px;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
.status{margin-top:8px;color:#b71c1c;font-weight:700}
.buttons-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:12px 0}
.listening{background:#ff9800 !important;color:#000 !important}
</style>
</head>
<body>
<div class="center">
<h1>рд╣рд┐рдВрджреА рдСрдбрд┐рдпреЛ рдХреНрд╡рд┐рдЬрд╝ тАФ рд▓рд┐рдВрдЧ & рд╡рдЪрди</h1>

<!-- LOGIN MODAL -->
<div id="loginModal">
  <div class="loginBox">
    <h3>рд▓реЙрдЧрд┐рди рдХрд░реЗрдВ</h3>
    <input id="loginName" type="text" placeholder="рдЕрдкрдирд╛ рдирд╛рдо рд▓рд┐рдЦреЗрдВ (Name)" />
    <div style="margin-top:10px">
      <button id="loginBtn" class="blue">рдкреНрд░рд╡реЗрд╢ рдХрд░реЗрдВ</button>
    </div>
    <p id="loginMsg" style="color:#c00;margin-top:10px"></p>
    <p style="font-size:0.9rem;color:#666;margin-top:12px">рдПрдХ рдмрд╛рд░ рдкреВрд░рд╛ рдХрд░рдиреЗ рдкрд░ рд╡рд╣реА рдирд╛рдо рдЙрд╕реА рдмреНрд░рд╛рдЙрдЬрд╝рд░/рдбрд┐рд╡рд╛рдЗрд╕ рд╕реЗ рдлрд┐рд░ рд╕реЗ рдХреНрд╡рд┐рдЬрд╝ рдирд╣реАрдВ рджреЗ рдкрд╛рдПрдЧрд╛ред</p>
  </div>
</div>

<!-- QUIZ AREA -->
<div id="quizArea" style="display:none">
  <div id="question">рдХреНрд╡рд┐рдЬрд╝ рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП "рд╢реБрд░реВ рдХрд░реЗрдВ" рджрдмрд╛рдПрдБ</div>
  <div id="translation">(Listen and answer)</div>
  <input id="answerInput" type="text" placeholder="рдЙрддреНрддрд░ рдмреЛрд▓рд┐рдП рдпрд╛ рд▓рд┐рдЦрд┐рдП (Enter рд╕реЗ рдЬрд╛рдБрдЪреЗрдВ)" />
  <div class="controls buttons-row">
    <button id="startBtn" class="blue">тЦ╢я╕П рд╢реБрд░реВ рдХрд░реЗрдВ</button>
    <button id="resetBtn" class="gray">ЁЯФБ рд░реАрд╕реЗрдЯ</button>
    <button id="speakBtn" class="blue">ЁЯОд рдмреЛрд▓реЗрдВ</button>
    <button id="passBtn" class="gray">тПн рдкрд╛рд╕</button>
    <button id="replayBtn" class="blue">ЁЯФБ рдлрд┐рд░ рд╕реБрдиреЗрдВ</button>
    <button id="checkBtn" class="blue">тЬЕ рдЬрд╛рдБрдЪреЗрдВ</button>
  </div>
  <div id="feedback"></div>
  <div id="score" class="small"></div>
  <button id="logoutBtn">ЁЯФТ рд▓реЙрдЧрдЖрдЙрдЯ рдФрд░ рд░рд┐рдкреЛрд░реНрдЯ рднреЗрдЬреЗрдВ</button>
  <p class="note" id="voiceWarn" style="display:none">ЁЯФ┤ рдЖрдкрдХреЗ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдореЗрдВ рд╣рд┐рдВрджреА рдЖрд╡рд╛рдЬрд╝ рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд░рд╣реА рд╣реИред рдХреГрдкрдпрд╛ Chrome рдпрд╛ Edge рдореЗрдВ рдЦреЛрд▓реЗрдВред</p>
  <p class="small">Chrome (desktop / HTTPS / localhost) рдкрд░ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ тАФ рдкрд╣рд▓реА рдмрд╛рд░ рдорд╛рдЗрдХреНрд░реЛрдлрд╝реЛрди рдЕрдиреБрдорддрд┐ рджреЗрдВред</p>
</div>
</div>

<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLOxs5vIy7zPBecZ0aCZKO8FeDMw0R2sDdptjIS299vrj1JgUW-7VGMxmLCieCLuIz4A/exec";
const WHATSAPP_PHONE = "919994895676";

const vachanQuestions = [
  { word: "рдмрд╛рд▓рдХ", answers:["рдмрд╛рд▓рдХ","рдмрд╛рд▓рдХ"] },
  { word: "рдХрд▓рдо ", answers:["рдХрд▓рдореЗрдВ","рдХрд▓рдореЗ"] },
  { word: "рдХреБрддреНрддрд╛", answers:["рдХреБрддреНрддреЗ","рдХреБрддреНрддреЗ"] },
  { word: "рдШреЛрдбрд╝рд╛", answers:["рдШреЛрдбрд╝реЗ","рдШреЛрдбрд╝реЗ"] },
  { word: "рджреЛрд╕реНрдд", answers:["рджреЛрд╕реНрдд","рджреЛрд╕реНрдд"] },
  { word: "рдЪрд┐рдбрд╝рд┐рдпрд╛", answers:["рдЪрд┐рдбрд╝рд┐рдпрд╛рдБ","рдЪрд┐рдбрд╝рд┐рдпрд╛рдПрдВ"] },
  { word: "рджреЗрд╡рддрд╛", answers:["рджреЗрд╡рддрд╛","рджреЗрд╡рддрд╛"] },
  { word: "рд▓рдбрд╝рдХреА", answers:["рд▓рдбрд╝рдХрд┐рдпрд╛рдБ","рд▓рдбрд╝рдХрд┐рдпрд╛рдВ"] },
  { word: "рдирджреА", answers:["рдирджрд┐рдпрд╛рдБ","рдирджрд┐рдпрд╛рдВ"] },
  { word: "рдлрд▓", answers:["рдлрд▓","рдлрд▓"] },
  { word: "рд╕рдбрд╝рдХ", answers:["рд╕рдбрд╝рдХреЗрдВ","рд╕рдбрд╝рдХреЗ"] },
  { word: "рдЧрд╛рдбрд╝реА", answers:["рдЧрд╛рдбрд╝рд┐рдпрд╛рдБ","рдЧрд╛рдбрд╝рд┐рдпреЛрдВ"] },
  { word: "рдХрд┐рддрд╛рдм", answers:["рдХрд┐рддрд╛рдмреЗрдВ","рдХрд┐рддрд╛рдмреЗ"] }
];

const lingQuestions = [
  { word:"рд╕рд╛рд╣рдм", male:["рд╕рд╛рд╣рдм"], female:["рд╕рд╛рд╣рд┐рдмрд╛"] },
  { word:"рд╢реЗрд░", male:["рд╢реЗрд░"], female:["рд╢реЗрд░рдиреА"] },
  { word:"рдХреБрддреНрддрд╛", male:["рдХреБрддреНрддрд╛"], female:["рдХреБрддрд┐рдпрд╛"] },
  { word:"рдЕрднрд┐рдиреЗрддрд╛", male:["рдЕрднрд┐рдиреЗрддрд╛"], female:["рдЕрднрд┐рдиреЗрддреНрд░реА"] },
  { word:"рдШреЛрдбрд╝рд╛", male:["рдШреЛрдбрд╝рд╛"], female:["рдШреЛрдбрд╝реА"] },
  { word:"рдмреИрд▓", male:["рдмреИрд▓"], female:["рдЧрд╛рдп"] },
  { word:"рдард╛рдХреБрд░", male:["рдард╛рдХреБрд░"], female:["рдардХреБрд░рд╛рдИрди"] },
  { word:"рдпреБрд╡рдХ", male:["рдпреБрд╡рдХ"], female:["рдпреБрд╡рддреА"] },
  { word:"рдЕрдзреНрдпрд╛рдкрдХ", male:["рдЕрдзреНрдпрд╛рдкрдХ"], female:["рдЕрдзреНрдпрд╛рдкрд┐рдХрд╛"] },
  { word:"рд╕реЗрда", male:["рд╕реЗрда"], female:["рд╕реЗрдард╛рдиреА"] },
  { word:"рдмрдХрд░рд╛", male:["рдмрдХрд░рд╛"], female:["рдмрдХрд░реА"] },
  { word:"рд╕реБрдирд╛рд░", male:["рд╕реБрдирд╛рд░"], female:["рд╕реБрдирд╛рд░реАрди"] },
  { word:"рдЪреМрдзрд░реА", male:["рдЪреМрдзрд░реА"], female:["рдЪреМрдзрд░рд╛рдИрди"] },
  { word:"рд▓реБрд╣рд╛рд░", male:["рд▓реБрд╣рд╛рд░"], female:["рд▓реБрд╣рд╛рд░реАрди"] }
];

let pool = [];
vachanQuestions.forEach(q => pool.push(Object.assign({type:'vachan'}, q)));
lingQuestions.forEach(q => pool.push(Object.assign({type:'ling'}, q)));

function shuffle(a) { 
  for(let i = a.length - 1; i > 0; i--) { 
    const j = Math.floor(Math.random() * (i + 1)); 
    [a[i], a[j]] = [a[j], a[i]]; 
  } 
}

let idx = 0, score = 0, started = false, startTime = 0, loginTime = '';
let recognition = null;
let currentUtterance = null;

const loginModal = document.getElementById('loginModal');
const loginName = document.getElementById('loginName');
const loginBtn = document.getElementById('loginBtn');
const loginMsg = document.getElementById('loginMsg');
const quizArea = document.getElementById('quizArea');
const questionEl = document.getElementById('question');
const translationEl = document.getElementById('translation');
const answerInput = document.getElementById('answerInput');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const speakBtn = document.getElementById('speakBtn');
const passBtn = document.getElementById('passBtn');
const replayBtn = document.getElementById('replayBtn');
const checkBtn = document.getElementById('checkBtn');
const feedbackEl = document.getElementById('feedback');
const scoreEl = document.getElementById('score');
const logoutBtn = document.getElementById('logoutBtn');
const voiceWarn = document.getElementById('voiceWarn');

function normalize(s) { 
  return s ? s.toString().normalize('NFD').replace(/[\u093C-\u094D\u0964-\u0965\s\p{P}]/gu, '').toLowerCase() : ''; 
}

function matchAnswer(inp, expected) { 
  return expected.some(e => normalize(inp) === normalize(e)); 
}

function speakQuestion() {
  const text = questionEl.textContent;
  
  const hiVoices = speechSynthesis.getVoices().filter(v => v.lang.includes('hi'));
  
  if (hiVoices.length) {
    speechSynthesis.cancel();
    currentUtterance = new SpeechSynthesisUtterance(text);
    currentUtterance.lang = 'hi-IN';
    currentUtterance.rate = 0.7;
    speechSynthesis.speak(currentUtterance);
    feedbackEl.textContent = 'рд╕реБрди рд░рд╣реЗ рд╣реИрдВ...';
  } else {
    questionEl.style.background = '#ffeb3b';
    feedbackEl.textContent = 'рдкрд╛рда рдкрдврд╝реЗрдВ: ' + text;
    setTimeout(() => questionEl.style.background = '', 2000);
  }
}

function startSpeechRecognition() {
  if (location.protocol !== 'https:') {
    feedbackEl.textContent = 'HTTPS рдЬрд░реВрд░реА рд╣реИ';
    return;
  }
  
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    feedbackEl.textContent = 'рдорд╛рдЗрдХ рд╕рдкреЛрд░реНрдЯ рдирд╣реАрдВ';
    voiceWarn.style.display = 'block';
    return;
  }
  
  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = 'hi-IN';
  
  recognition.onstart = () => {
    speakBtn.innerHTML = 'ЁЯЯб рд╕реБрди рд░рд╣рд╛...';
    speakBtn.classList.add('listening');
    feedbackEl.textContent = 'рдмреЛрд▓реЗрдВ...';
  };
  recognition.onerror = (e) => {
    feedbackEl.textContent = `рдорд╛рдЗрдХ рддреНрд░реБрдЯрд┐: ${e.error}`;
    speakBtn.innerHTML = 'ЁЯОд рдмреЛрд▓реЗрдВ';
    speakBtn.classList.remove('listening');
  };
  recognition.onend = () => {
    speakBtn.innerHTML = 'ЁЯОд рдмреЛрд▓реЗрдВ';
    speakBtn.classList.remove('listening');
  };
  
  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    answerInput.value = transcript;
    feedbackEl.textContent = `"${transcript}" рд╕реБрдирд╛ рдЧрдпрд╛`;
    setTimeout(() => checkBtn.click(), 800);
  };
  
  try {
    recognition.start();
  } catch (e) {
    feedbackEl.textContent = 'рдорд╛рдЗрдХ рд╢реБрд░реВ рдирд╣реАрдВ рд╣реЛ рд╕рдХрд╛: ' + e.message;
  }
}

function showQuestion() {
  if (idx >= pool.length) { 
    endQuiz(); 
    return; 
  }
  const q = pool[idx];
  if (q.type === 'vachan') {
    questionEl.textContent = `рд╡рдЪрди рдмрджрд▓рд┐рдП: ${q.word} рдХрд╛ рдмрд╣реБрд╡рдЪрди рдмрддрд╛рдЗрдП`;
    translationEl.textContent = `(Change to plural)`;
    q._expected = q.answers;
  } else {
    if (Math.random() < 0.5) { 
      questionEl.textContent = `рд▓рд┐рдВрдЧ рдмрджрд▓рд┐рдП: ${q.word} рдХрд╛ рдкреБрд▓реНрд▓рд┐рдВрдЧ рдмрддрд╛рдЗрдП`; 
      translationEl.textContent = `(Change to masculine)`; 
      q._expected = q.male; 
    } else { 
      questionEl.textContent = `рд▓рд┐рдВрдЧ рдмрджрд▓рд┐рдП: ${q.word} рдХрд╛ рд╕реНрддреНрд░реАрд▓рд┐рдВрдЧ рдмрддрд╛рдЗрдП`; 
      translationEl.textContent = `(Change to feminine)`; 
      q._expected = q.female; 
    }
  }
  answerInput.value = ''; 
  feedbackEl.textContent = ''; 
  answerInput.disabled = false; 
  passBtn.disabled = false; 
  replayBtn.disabled = false;
  speakBtn.disabled = false;
}

startBtn.onclick = () => { 
  if (!started) { 
    started = true; 
    idx = 0; 
    score = 0; 
    startTime = Date.now(); 
    shuffle(pool); 
    showQuestion(); 
    scoreEl.textContent = ''; 
  } 
};

resetBtn.onclick = () => { 
  started = false; 
  idx = 0; 
  score = 0; 
  speechSynthesis.cancel();
  if (recognition) recognition.stop();
  questionEl.textContent = 'рдХреНрд╡рд┐рдЬрд╝ рд░реАрд╕реЗрдЯ рд╣реБрдЖред "рд╢реБрд░реВ рдХрд░реЗрдВ" рджрдмрд╛рдПрдБ'; 
  feedbackEl.textContent = ''; 
  scoreEl.textContent = ''; 
  answerInput.disabled = true;
  speakBtn.disabled = true;
  passBtn.disabled = true;
  replayBtn.disabled = true;
};

replayBtn.onclick = speakQuestion;
speakBtn.onclick = startSpeechRecognition;

checkBtn.onclick = () => { 
  const v = answerInput.value.trim(); 
  if (!v) { 
    feedbackEl.className = 'wrong'; 
    feedbackEl.textContent = 'рдХреГрдкрдпрд╛ рдЙрддреНрддрд░ рджреЗрдВ'; 
    return; 
  } 
  checkAnswerInput(v); 
};

function checkAnswerInput(userTxt) {
  const q = pool[idx];
  if (matchAnswer(userTxt, q._expected)) {
    score++;
    feedbackEl.className = 'correct'; 
    feedbackEl.textContent = 'рд╕рд╣реА рдЙрддреНрддрд░ тЬУ';
    answerInput.disabled = true;
    speakBtn.disabled = true;
    passBtn.disabled = true;
    idx++; 
    setTimeout(showQuestion, 1000);
  } else {
    feedbackEl.className = 'wrong'; 
    feedbackEl.textContent = 'рдЧрд▓рдд рдЙрддреНрддрд░ тАФ рдлрд┐рд░ рд╕реЗ рдмреЛрд▓реЗрдВ рдпрд╛ рдкрд╛рд╕ рджрдмрд╛рдПрдБред';
  }
}

answerInput.addEventListener('keydown', e => { 
  if (e.key === 'Enter') checkBtn.click(); 
});

passBtn.onclick = () => { 
  idx++; 
  showQuestion(); 
};

function endQuiz() {
  started = false; 
  speechSynthesis.cancel();
  if (recognition) recognition.stop();
  questionEl.textContent = 'рдХреНрд╡рд┐рдЬрд╝ рд╕рдорд╛рдкреНрдд!'; 
  translationEl.textContent = ''; 
  feedbackEl.textContent = '';
  scoreEl.textContent = `рдЖрдкрдХрд╛ рд╕реНрдХреЛрд░: ${score} / ${pool.length}`;
  answerInput.disabled = true;
  speakBtn.disabled = true;
  passBtn.disabled = true;
  replayBtn.disabled = true;
}

logoutBtn.onclick = async () => {
  const name = localStorage.getItem('quiz_user_name') || loginName.value || 'Unknown';
  const total = pool.length;
  const duration = ((Date.now() - startTime) / 1000 / 60).toFixed(1);

  const payload = {
    action: "logout", 
    name: name, 
    loginTime: loginTime,
    score: score, 
    attempted: idx, 
    total: total,
    duration: duration + " рдорд┐рдирдЯ",
    remarks: ""
  };

  try { 
    await fetch(APPS_SCRIPT_URL, {
      method: 'POST', 
      headers: {'Content-Type': 'application/json'}, 
      body: JSON.stringify(payload)
    }); 
  } catch (e) { 
    console.warn(e); 
  }

  const waMsg = encodeURIComponent(`рдирдорд╕реНрддреЗ! рдореИрдВ ${name} рд╣реВрдБред рдореЗрд░рд╛ рд╕реНрдХреЛрд░ ${score}/${total} рд╣реИ (${duration} рдорд┐рдирдЯ рдореЗрдВ)ред`);
  window.open(`https://wa.me/${WHATSAPP_PHONE}?text=${waMsg}`, '_blank');

  localStorage.setItem('quiz_done_for_' + name, JSON.stringify({
    score, total, time: new Date().toLocaleString()
  }));
  localStorage.removeItem('quiz_user_name');
  alert('рд░рд┐рдкреЛрд░реНрдЯ рднреЗрдЬреА рдЧрдпреА рдФрд░ WhatsApp рдбреНрд░рд╛рдлреНрдЯ рдЦреБрд▓ рдЧрдпрд╛ред');
  location.reload();
};

loginBtn.onclick = () => {
  const name = loginName.value.trim();
  if (!name) { 
    loginMsg.textContent = "рдХреГрдкрдпрд╛ рдирд╛рдо рджрд░реНрдЬ рдХрд░реЗрдВ"; 
    return; 
  }
  if (localStorage.getItem('quiz_done_for_' + name)) { 
    loginMsg.textContent = "рдЖрдкрдиреЗ рдкрд╣рд▓реЗ рд╣реА рдпрд╣ рдХреНрд╡рд┐рдЬрд╝ рдкреВрд░рд╛ рдХрд░ рд▓рд┐рдпрд╛ рд╣реИред"; 
    return; 
  }
  loginTime = new Date().toLocaleString();
  localStorage.setItem('quiz_user_name', name);
  loginModal.style.display = 'none'; 
  quizArea.style.display = 'block';

  // Preload voices now
  speechSynthesis.getVoices();
  speechSynthesis.onvoiceschanged = () => {
    const hiVoices = speechSynthesis.getVoices().filter(v => v.lang.includes('hi'));
    if (hiVoices.length === 0) {
      voiceWarn.style.display = 'block';
    } else {
      voiceWarn.style.display = 'none';
    }
  };
};

function preloadVoices() {
  return new Promise(resolve => {
    let voices = speechSynthesis.getVoices();
    if (voices.length) {
      resolve(voices);
    } else {
      speechSynthesis.onvoiceschanged = () => {
        voices = speechSynthesis.getVoices();
        resolve(voices);
      };
    }
  });
}

window.addEventListener('load', async () => {
  const sessionName = localStorage.getItem('quiz_user_name');
  const done = sessionName ? localStorage.getItem('quiz_done_for_' + sessionName) : null;
  if (sessionName && !done) {
    loginName.value = sessionName;
    loginModal.style.display = 'none';
    quizArea.style.display = 'block';
    answerInput.disabled = true;
    speakBtn.disabled = true;
    passBtn.disabled = true;
    replayBtn.disabled = true;
  } else {
    loginModal.style.display = 'flex';
    quizArea.style.display = 'none';
  }

  const voices = await preloadVoices();
  const hiVoices = voices.filter(v => v.lang.includes('hi'));
  if (hiVoices.length === 0) {
    voiceWarn.style.display = 'block';
  } else {
    voiceWarn.style.display = 'none';
  }
});
</script>
</body>
</html>
